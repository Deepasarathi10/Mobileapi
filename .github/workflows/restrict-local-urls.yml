name: Restrict Local URLs

on:
  push:
    branches:
      - main
      - release/*

jobs:
  check-local-urls:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Scan for local URLs
        run: |
          echo "ðŸ” Checking for local URLs..."

          # Define the regex pattern for local URLs
          grep_pattern='(localhost|127\.0\.0\.1|::1)'

          # Search while excluding .git and this workflow file
          all_matches=$(grep -rIniE "$grep_pattern" . \
            --exclude-dir=".git" \
            --exclude=".github/workflows/restrict-local-urls.yml" \
            || true)

          # Remove matches that are commented out (lines starting with '#', possibly no space)
          filtered_matches=$(echo "$all_matches" | grep -vE ':[0-9]+:\s*#|:[0-9]+:#' || true)

          # Also remove accidental matches of this workflow itself
          filtered_matches=$(echo "$filtered_matches" | grep -v ".github/workflows/restrict-local-urls.yml" || true)

          if [ -n "$filtered_matches" ]; then
            echo "âŒ Local URLs found:"
            echo "$filtered_matches"
            echo "$filtered_matches" > local-url-report.txt
            exit 1
          else
            echo "âœ… No local URLs found. Safe to deploy."
          fi

      - name: Upload Local URL Report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: local-url-report
          path: local-url-report.txt

  deploy:
    runs-on: ubuntu-latest
    needs: check-local-urls
    if: success()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Cloud
        run: |
          echo "ðŸš€ Deploying application to cloud..."
          # your deployment steps here
